<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>kizuna リアルタイムテスト</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>kizuna Realtime Test</h1>
    <div id="status" style="color: green;">リアルタイム監視中...</div>
    <pre id="output">読み込み中...</pre>

    <script>
        const SUPABASE_URL = 'https://jnordvkkajlengzfaxzj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_jpR2JZ7Mue2EPEqELM71iw_AcwermIp';

        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // データを取得して表示する関数
        async function fetchDisplay() {
            const { data, error } = await sbClient.from('test_log').select('*');
            if (error) {
                document.getElementById('output').innerText = 'エラー: ' + error.message;
            } else {
                document.getElementById('output').innerText = JSON.stringify(data, null, 2);
            }
        }

        // リアルタイム受信の設定
        sbClient
            .channel('any') // 任意のチャンネル名
            .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'test_log' }, 
                (payload) => {
                    alert('変化を検知しました！' + payload);
                    fetchDisplay(); // 変化があったら再読み込みして表示を更新
                }
            )
            .subscribe();

        // 初回読み込み
        fetchDisplay();
    </script>
</body>
</html>
